"use client";
/**
 * COMPLETE REWRITE: RecommendationSystem.jsx
 * Styl: Dark / Neon (Duolingo + Notion + Apple fusion), pełne karty zamiast list, wielotrybowy interaktywny system.
 * Funkcje:
 *  - Hero (Top Match) z dynamiczną animacją wartości dopasowania
 *  - SwipeDeck (gest / przyciski / klawiatura) – akceptuj / odrzuć / zapisz
 *  - Dashboard (siatka kart + filtry + sortowanie + szybkie tagi)
 *  - Story Mode (sekwencyjne odsłanianie dopasowań jak mentoring / narracja AI)
 *  - LegacyList fallback (opcjonalnie integracja starego komponentu przez dynamiczny import)
 *  - LocalStorage persistence: decyzje (accepted/saved/rejected) + ostatni tryb
 *  - Hotkeys: ← → (nawigacja), A (akceptuj), R (odrzuć), S (zapisz), M (zmiana trybu), H (hero)
 *  - Explainability: generowana z careerMatcher (explanation) + breakdown heatmap
 *  - Focus / Flow / Feedback: tryby nie przeładowują danych, spójny viewport, natychmiastowy feedback przy akcjach
 *  - Wiele subkomponentów w jednym pliku (świadomie duży plik wg wymagań – łatwe dalsze rozbicie)
 *  - Minimum ~700 linii kodu (rozbudowane sekcje, komentarze merytoryczne)
 */

import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import dynamic from 'next/dynamic';
import { motion, AnimatePresence } from 'framer-motion';
import { useCareerMatching } from '@/hooks/useCareerMatching';
import { matchCareers } from '@/utils/careerMatcher';
import { CAREER_PATHS } from '@/app/data/careerPaths';
// (Type imports usunięte – plik w czystym JS)
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import Progress from '@/components/ui/progress';
import {
  Activity, ArrowLeft, ArrowRight, BookOpen, Brain, Check, CheckCircle2, Circle, Flame,
  Github, LayoutGrid, List, Loader2, Rocket, Rows3, Sparkles, Square, Wand2, X,
  RefreshCw, BarChart3, BarChart2, Landmark, Compass, Lightbulb, Info, HelpCircle,
  Eye, EyeOff, Clock, ChartSpline, CloudLightning, Zap, Star, Save, Trash2, AlertTriangle,
  Target, Map as MapIcon, Gauge, BarChart, Layers
} from 'lucide-react';

// ----------------------------- Konfiguracja / stałe ----------------------------- //

const LOCAL_KEY = 'pf_reco_state_v1';
const MODE_KEY = 'pf_reco_mode_v1';
const DECISIONS_KEY = 'pf_reco_decisions_v1';

/** Dostępne tryby interfejsu */
// Rozszerzone tryby: compare (porównanie), radar (wielokąt czynników), market (macierz trend/stabilność)
const MODES = ['spotlight','hero','swipe','dashboard','compare','radar','market','story','legacy'];
/** @typedef {typeof MODES[number]} Mode */

// Fallback dynamic import dla starej listy (opcjonalnie – ładowane tylko jeśli wybrane)
const LegacyList = dynamic(() => import('./RecommendationsTab'), { ssr: false, loading: () => <div className="text-xs text-slate-400">Ładowanie listy...</div> });

// Paleta gradientów dla kart zależna od id / kategorii
const GRADIENTS = [
  'from-violet-500 via-fuchsia-500 to-cyan-400',
  'from-emerald-500 via-teal-500 to-lime-400',
  'from-sky-500 via-indigo-500 to-purple-500',
  'from-rose-500 via-pink-500 to-orange-400',
  'from-amber-500 via-orange-500 to-pink-500',
  'from-cyan-500 via-blue-500 to-violet-500'
];

// Demo dataset (można później zastąpić realną bazą). Dodatkowe pola: category, miniDescription
// Map real dataset (CAREER_PATHS) -> matcher shape (CareerMatchBase)
const CAREERS = Object.values(CAREER_PATHS).map(c => ({
  id: c.id,
  name: c.name,
  requiredSkills: deriveSkillsFromTraits(c.requiredTraits),
  idealPersonality: Object.keys(c.requiredTraits || {}),
  relatedInterests: deriveInterests(c),
  salaryK: c.salary ? [Math.round((c.salary.min||0)/1000), Math.round((c.salary.max||0)/1000)] : undefined,
  market: {
    trend: normaliseDemand(c.demandScore),
    volatility: estimateVolatility(c),
    remoteAvailability: inferRemoteAvailability(c),
    regions: inferRegions(c),
    medianSalaryK: c.salary ? Math.round(((c.salary.min||0)+(c.salary.max||0))/2000) : undefined,
    values: deriveValues(c)
  }
}));

// ----------------------------- Helper funkcje narzędziowe ----------------------------- //

const clamp = (n, a=0, b=1) => Math.min(b, Math.max(a, n));
const pct = (x) => Math.round(clamp(x,0,1)*100);
const pickGradientFor = (id) => GRADIENTS[Math.abs(hashCode(id)) % GRADIENTS.length];
function hashCode(str='') { let h=0; for (let i=0;i<str.length;i++) { h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }

// Buduje przyjazny opis z explanation + top factors
function buildReadableInsight(result) {
  const ex = result.explanation || '';
  const heat = Object.entries(result.factors)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(([k,v])=> `${labelFactor(k)} ${pct(v)}%`)
    .join(' • ');
  return ex + (heat ? ` | Najmocniejsze: ${heat}` : '');
}

function labelFactor(k) {
  const map = { skills:'Umiejętności', personality:'Styl', interests:'Zainteres.', salary:'Zarobki', values:'Wartości', market:'Rynek', location:'Lokalizacja' };
  return map[k] || k;
}

function estimateTimeMonths(id) {
  switch(id) {
    case 'frontend_dev': return 9; case 'backend_dev': return 10; case 'data_analyst': return 8; case 'ux_designer': return 6; case 'project_manager': return 5; default: return 7;
  }
}

// ---- Dataset mapping helpers (real dataset -> matcher) ---- //
function deriveSkillsFromTraits(traits = {}) {
  // Traits are 0..1 style numbers; map them directly as pseudo-skill features
  return Object.fromEntries(Object.entries(traits).map(([k,v]) => [humanizeTrait(k), clamp(v,0,1)]));
}
function humanizeTrait(k='') { return k.replace(/_/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); }
function deriveInterests(c) {
  const base = [];
  if (c.workEnvironment) base.push(c.workEnvironment);
  if (c.futureOutlook) base.push('trend');
  if (c.tools) base.push(...c.tools.slice(0,3));
  return base.map(x => (''+x).toLowerCase());
}
function normaliseDemand(score) { // dataset has 1..10 approx; map to -0.3..0.5 roughly
  if (typeof score !== 'number') return 0.1;
  const norm = (score - 5) / 5; // -? .. ? around 0
  return clamp(norm * 0.6, -0.5, 0.6);
}
function estimateVolatility(c) {
  // If demandScore very high → lower volatility; else medium.
  const s = c.demandScore || 5;
  return clamp(1 - (s / 12), 0.15, 0.7); // invert relative to score
}
function inferRemoteAvailability(c) {
  const env = (c.workEnvironment||'').toLowerCase();
  if (env.includes('zdal')) return 0.85;
  if (env.includes('biuro') && env.includes('teren')) return 0.4;
  if (env.includes('teren')) return 0.2;
  return 0.55;
}
function inferRegions(c) {
  const env = (c.workEnvironment||'').toLowerCase();
  if (env.includes('zdal')) return ['PL','remote'];
  return ['PL'];
}
function deriveValues(c) {
  const arr = [];
  if (c.futureOutlook?.toLowerCase().includes('rozw')) arr.push('rozwój');
  if (c.futureOutlook?.toLowerCase().includes('stabil')) arr.push('stabilność');
  if (c.futureOutlook?.toLowerCase().includes('transform')) arr.push('innowacja');
  if (c.demand && c.demand.toLowerCase().includes('wysok')) arr.push('popyt');
  return Array.from(new Set(arr));
}

// ----------------------------- Hook: decyzje + persistence ----------------------------- //

function useDecisionStore() {
  const [decisions, setDecisions] = useState(()=>{
    if (typeof window === 'undefined') return { accepted:[], saved:[], rejected:[] };
    try { const raw = localStorage.getItem(DECISIONS_KEY); if (raw) return JSON.parse(raw); } catch {};
    return { accepted:[], saved:[], rejected:[] };
  });

  const persist = (next) => {
    setDecisions(next);
    try { localStorage.setItem(DECISIONS_KEY, JSON.stringify(next)); } catch {}
  };

  const accept = (id) => { if (decisions.accepted.includes(id)) return; persist({ ...decisions, accepted:[...decisions.accepted,id], rejected: decisions.rejected.filter(x=>x!==id) }); };
  const reject = (id) => { if (decisions.rejected.includes(id)) return; persist({ ...decisions, rejected:[...decisions.rejected,id], accepted: decisions.accepted.filter(x=>x!==id) }); };
  const save = (id) => { if (decisions.saved.includes(id)) return; persist({ ...decisions, saved:[...decisions.saved,id] }); };
  const reset = () => persist({ accepted:[], saved:[], rejected:[] });

  return { decisions, accept, reject, save, reset };
}

// ----------------------------- Główny komponent ----------------------------- //

/**
 * RecommendationSystem – punkt centralny UI rekomendacji.
 * Props: profile (legacy shape lub nowy), careers (opcjonalnie override dataset), onSelectCareer (callback na decyzję)
 */
export default function RecommendationSystem({
  profile: legacyProfile,
  careers = CAREERS,
  onSelectCareer,
  className = ''
}) {
  // Mapowanie legacy → UserProfile
  const profile = useMemo(()=>({
    skills: legacyProfile?.skills || {},
    personality: legacyProfile?.strengths || legacyProfile?.personality || [],
    interests: legacyProfile?.preferences || legacyProfile?.interests || [],
    values: legacyProfile?.values || ['rozwój','stabilność'],
    location: legacyProfile?.location || 'PL',
    preferences: { remote: true, stabilityImportance: 0.6, salaryImportance: 0.5 }
  }), [legacyProfile]);

  // Wyniki dopasowania (czysty matcher) – pojedyncze obliczenie
  const results = useCareerMatching(profile, careers, { explain: true }) || [];

  // Tryb UI (persist)
  const [mode, setMode] = useState(()=>{
    if (typeof window === 'undefined') return 'hero';
    try { return localStorage.getItem(MODE_KEY) || 'hero'; } catch { return 'hero'; }
  });
  const setModePersist = (m) => { setMode(m); try { localStorage.setItem(MODE_KEY, m); } catch {} };

  // Decyzje → store
  const { decisions, accept, reject, save, reset } = useDecisionStore();

  // Sortowanie / filtrowanie dla dashboardu
  const [sortKey, setSortKey] = useState('score');
  const [query, setQuery] = useState('');
  const filtered = useMemo(()=>{
    return results.filter(r => r.career.name.toLowerCase().includes(query.toLowerCase()));
  }, [results, query]);
  const sorted = useMemo(()=>{
    const arr = [...filtered];
    arr.sort((a,b)=> (b.score - a.score));
    if (sortKey === 'salary') arr.sort((a,b)=>( (b.career.salaryK?.[1]||0) - (a.career.salaryK?.[1]||0)) );
    if (sortKey === 'trend') arr.sort((a,b)=>( (b.career.market?.trend||0) - (a.career.market?.trend||0) ));
    return arr;
  }, [filtered, sortKey]);

  // Top match (hero)
  const top = results[0];

  // Story mode – indeks narracji
  const [storyIndex, setStoryIndex] = useState(0);
  const advanceStory = () => setStoryIndex(i => Math.min(results.length-1, i+1));
  const regressStory = () => setStoryIndex(i => Math.max(0, i-1));

  // Swipe deck – lokalna talia bazująca na posortowanych wynikach (tylko id + snapshot);
  const [swipeDeck, setSwipeDeck] = useState(()=>results.map(r=>r.career.id));
  useEffect(()=>{ setSwipeDeck(results.map(r=>r.career.id)); }, [results.length]);
  const currentSwipeId = swipeDeck[0];
  const currentSwipeResult = results.find(r=>r.career.id===currentSwipeId);
  const handleSwipeDecision = (id, action) => {
    if (action==='accept') accept(id); else if (action==='reject') reject(id); else if (action==='save') save(id);
    setSwipeDeck(d => d.filter(x=>x!==id));
  };

  // Hotkeys
  useEffect(()=>{
    const onKey = (e) => {
      if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
      if (e.key === 'ArrowLeft') { if (mode==='story') regressStory(); }
      if (e.key === 'ArrowRight') { if (mode==='story') advanceStory(); }
      if (e.key.toLowerCase() === 'a') { if (currentSwipeId && mode==='swipe') handleSwipeDecision(currentSwipeId,'accept'); }
      if (e.key.toLowerCase() === 'r') { if (currentSwipeId && mode==='swipe') handleSwipeDecision(currentSwipeId,'reject'); }
      if (e.key.toLowerCase() === 's') { if (currentSwipeId && mode==='swipe') handleSwipeDecision(currentSwipeId,'save'); }
  if (e.key.toLowerCase() === 'm') { cycleMode(); }
  if (e.key.toLowerCase() === 'h') { setModePersist('hero'); }
  if (e.key.toLowerCase() === 'c') { setModePersist('compare'); }
  if (e.key.toLowerCase() === 'k') { setModePersist('market'); }
  if (e.key.toLowerCase() === 'd') { setModePersist('radar'); }
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [mode, currentSwipeId, results.length]);

  const cycleMode = () => {
    const idx = MODES.indexOf(mode);
    const next = MODES[(idx+1) % MODES.length];
    setModePersist(next);
  };

  // Zdarzenia CTA
  const onStartPath = (id) => { accept(id); onSelectCareer?.(id); };

  // Prezentacja danych do hero (ensures stable shape)
  const heroData = useMemo(()=>{
    if (!top) return null;
    return {
      id: top.career.id,
      name: top.career.name,
      matchPct: pct(top.score),
      salary: top.career.salaryK ? `${top.career.salaryK[0]}–${top.career.salaryK[1]}k` : 'n/d',
      trend: Math.round(((top.career.market?.trend||0)+0.5)*100),
      time: estimateTimeMonths(top.career.id),
      explanation: buildReadableInsight(top),
      factors: top.factors
    };
  }, [top]);

  // Loading placeholder (gdy brak danych – teoretycznie szybkie, ale zachowujemy UX spójność)
  if (!results.length) {
    return (
      <div className={`w-full mx-auto max-w-7xl p-6 md:p-10 text-slate-300 ${className}`}>
        <div className="flex flex-col items-center gap-4 py-32">
          <Loader2 className="w-10 h-10 animate-spin text-violet-400" />
          <p className="text-sm text-slate-400">Analizuję Twój profil…</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`w-full mx-auto max-w-7xl p-4 md:p-8 space-y-8 text-slate-100 ${className}`}>
      <SystemHeader
        mode={mode}
        setMode={setModePersist}
        cycleMode={cycleMode}
        total={results.length}
        decisions={decisions}
        query={query}
        setQuery={setQuery}
        sortKey={sortKey}
        setSortKey={setSortKey}
      />

      {mode==='spotlight' && heroData && (
        <SpotlightMode
          data={heroData}
          result={top}
          onAccept={() => onStartPath(heroData.id)}
          onReject={() => reject(heroData.id)}
          onSave={() => save(heroData.id)}
          toSwipe={() => setModePersist('swipe')}
          toDashboard={() => setModePersist('dashboard')}
        />
      )}

      {mode==='hero' && heroData && (
        <HeroSection data={heroData} onStart={() => onStartPath(heroData.id)} onGoSwipe={()=> setModePersist('swipe')} />
      )}

      {mode==='swipe' && (
        <SwipeDeck
          results={results}
          deckIds={swipeDeck}
          current={currentSwipeResult}
          onDecision={handleSwipeDecision}
          decisions={decisions}
        />
      )}

      {mode==='compare' && (
        <CompareMode
          results={results}
          decisions={decisions}
          onAccept={accept}
          onReject={reject}
          onSave={save}
        />
      )}

      {mode==='radar' && (
        <RadarMode
          results={results}
          profile={profile}
          onAccept={accept}
          onReject={reject}
          onSave={save}
          decisions={decisions}
        />
      )}

      {mode==='market' && (
        <MarketMode
          results={results}
          onAccept={accept}
          onReject={reject}
          onSave={save}
          decisions={decisions}
        />
      )}

      {mode==='dashboard' && (
        <DashboardView
          results={sorted}
          decisions={decisions}
          onAccept={accept}
          onReject={reject}
          onSave={save}
          onSelect={onStartPath}
        />
      )}

      {mode==='story' && (
        <StoryMode
          results={results}
          index={storyIndex}
          onNext={advanceStory}
          onPrev={regressStory}
          onAccept={accept}
          onReject={reject}
          onSave={save}
        />
      )}

      {mode==='legacy' && (
        <div className="mt-4">
          <LegacyList userProfile={legacyProfile} />
        </div>
      )}

      <FooterPanel
        resetDecisions={reset}
        decisions={decisions}
        results={results}
      />
    </div>
  );
}

// ----------------------------- SystemHeader ----------------------------- //

function SystemHeader({ mode, setMode, cycleMode, total, decisions, query, setQuery, sortKey, setSortKey }) {
  return (
    <div className="flex flex-col gap-6">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 className="text-3xl md:text-4xl font-bold tracking-tight bg-gradient-to-r from-emerald-400 via-violet-400 to-cyan-400 bg-clip-text text-transparent">Twój Inteligentny Mentor Kariery</h1>
          <p className="text-sm md:text-base text-slate-400 mt-2 max-w-2xl">System AI analizuje umiejętności, styl pracy, wartości i trend rynkowy – dostarczając rekomendacje dopasowane do Twojej trajektorii wzrostu.</p>
          <div className="mt-3 flex flex-wrap gap-2 text-[11px] text-slate-400">
            <span className="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/50">{total} ścieżek</span>
            <span className="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/50">Akceptowane: {decisions.accepted.length}</span>
            <span className="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/50">Zapisane: {decisions.saved.length}</span>
            <span className="px-2 py-1 rounded-full bg-slate-800/60 border border-slate-700/50">Odrzucone: {decisions.rejected.length}</span>
          </div>
        </div>
        <div className="flex items-center gap-2 flex-wrap">
          {MODES.map(m => (
            <Button
              key={m}
              variant={mode===m? 'default':'outline'}
              onClick={()=>setMode(m)}
              className={mode===m? 'bg-violet-600 hover:bg-violet-500':''}
            >
              {iconForMode(m)} <span className="ml-1 capitalize hidden sm:inline">{m}</span>
            </Button>
          ))}
          <Button variant="outline" onClick={cycleMode} className="gap-1 text-slate-300">↻ <span className="hidden sm:inline">Przełącz</span></Button>
        </div>
      </div>

      {/* Search & sort row (dashboard relevant) */}
      <div className="flex flex-col md:flex-row gap-4 md:items-center justify-between">
        <div className="flex gap-3 flex-1">
          <div className="relative flex-1">
            <input
              value={query}
              onChange={e=>setQuery(e.target.value)}
              placeholder="Szukaj roli…"
              className="w-full h-11 bg-slate-900/70 border border-slate-700/60 rounded-xl px-4 text-sm focus:outline-none focus:ring-2 focus:ring-violet-500/60 text-slate-200 placeholder:text-slate-500"
            />
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs">CTRL+F</span>
          </div>
          <select
            value={sortKey}
            onChange={e=>setSortKey(e.target.value)}
            className="h-11 bg-slate-900/70 border border-slate-700/60 rounded-xl px-3 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-violet-500/60"
          >
            <option value="score">Sort: Dopasowanie</option>
            <option value="salary">Sort: Zarobki (max)</option>
            <option value="trend">Sort: Trend</option>
          </select>
        </div>
        <HotkeyLegend />
      </div>
    </div>
  );
}

function iconForMode(m) {
  switch(m){
    case 'spotlight': return <Target className="w-4 h-4" />;
    case 'hero': return <Sparkles className="w-4 h-4" />;
    case 'swipe': return <Flame className="w-4 h-4" />;
    case 'dashboard': return <LayoutGrid className="w-4 h-4" />;
    case 'compare': return <BarChart className="w-4 h-4" />;
    case 'radar': return <Gauge className="w-4 h-4" />;
    case 'market': return <Landmark className="w-4 h-4" />;
    case 'story': return <BookOpen className="w-4 h-4" />;
    case 'legacy': return <List className="w-4 h-4" />;
    default: return <Circle className="w-4 h-4" />;
  }
}

// ----------------------------- HeroSection ----------------------------- //

// --- ZAAWANSOWANY SPOTLIGHT (dynamiczne zadania, kontekst, animowana siatka) ---
function SpotlightMode({ data, result, onAccept, onReject, onSave, toSwipe, toDashboard }) {
  const diagnostics = computeProfileDiagnostics(result);
  const { tasks, benefits } = diagnostics;
  const matchCircle = (
    <div className="relative h-56 w-56 flex items-center justify-center" aria-label="Dopasowanie" role="img">
      <svg viewBox="0 0 120 120" className="h-56 w-56 rotate-[-90deg]">
        <circle cx="60" cy="60" r="54" stroke="rgba(100,116,139,0.25)" strokeWidth="8" fill="none" />
        <circle cx="60" cy="60" r="54" stroke="url(#gradMatch)" strokeLinecap="round" strokeWidth="8" fill="none" strokeDasharray={Math.PI*108} strokeDashoffset={Math.PI*108 * (1 - data.matchPct/100)} className="transition-[stroke-dashoffset] duration-1000 ease-[cubic-bezier(.22,1,.36,1)]" />
        <defs>
          <linearGradient id="gradMatch" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="#10b981" />
            <stop offset="50%" stopColor="#8b5cf6" />
            <stop offset="100%" stopColor="#06b6d4" />
          </linearGradient>
        </defs>
      </svg>
      <div className="absolute inset-0 flex flex-col items-center justify-center">
        <div className="text-4xl font-bold bg-gradient-to-r from-emerald-400 via-violet-400 to-cyan-400 bg-clip-text text-transparent tabular-nums">{data.matchPct}%</div>
        <div className="text-xs tracking-wide text-slate-400 mt-1 uppercase">Dopasowanie</div>
      </div>
    </div>
  );
  return (
    <div className="relative min-h-[680px] grid grid-cols-12 gap-6">
      {/* Lewy panel */}
      <aside className="hidden xl:flex xl:flex-col col-span-3 gap-4" aria-label="Priorytety">
        <Card className="border-slate-700/60 bg-slate-950/70 backdrop-blur">
          <CardHeader className="pb-3"><CardTitle className="text-sm font-semibold text-slate-300 flex items-center gap-2"><AlertTriangle className="w-4 h-4 text-amber-400" /> Priorytetowe działania</CardTitle></CardHeader>
          <CardContent className="pt-0 space-y-3">
            {tasks.map(t => (
              <div key={t.id} className="group p-3 rounded-xl border border-slate-700/60 bg-slate-900/60 hover:border-violet-500/40 transition flex flex-col gap-2">
                <div className="flex items-center gap-2">
                  <span className="inline-flex h-6 w-6 items-center justify-center rounded-md bg-slate-800 text-[11px] text-amber-300 ring-1 ring-slate-600/50">!</span>
                  <span className="text-xs text-slate-200 font-medium leading-tight" aria-label={t.label}>{t.label}</span>
                </div>
                <div className="h-1.5 w-full rounded-full bg-slate-800 overflow-hidden" aria-hidden="true">
                  <div className="h-full bg-gradient-to-r from-red-500 via-amber-400 to-yellow-300" style={{ width: (t.risk*100)+'%' }} />
                </div>
                <div className="text-[10px] uppercase tracking-wide text-slate-500 flex items-center justify-between"><span>Ryzyko {(t.risk*100)|0}%</span><span className="text-slate-400">{t.impact}</span></div>
                {t.tip && <div className="text-[10px] text-slate-500 leading-snug">{t.tip}</div>}
              </div>
            ))}
          </CardContent>
        </Card>
        <Card className="border-slate-700/60 bg-slate-950/60 p-4 hidden 2xl:block">
          <div className="text-xs font-semibold tracking-wide uppercase text-slate-400 mb-2 flex items-center gap-2"><MapIcon className="w-4 h-4 text-cyan-400" /> Kontekst rynku</div>
          <div className="aspect-[4/3] w-full rounded-xl bg-gradient-to-br from-slate-800 via-slate-900 to-slate-950 relative overflow-hidden">
            <MarketMiniViz factor={result.factors.market} trend={data.trend} />
          </div>
        </Card>
      </aside>
      {/* Centrum */}
      <div className="col-span-12 xl:col-span-6 flex flex-col items-center">
        <motion.div initial={{ opacity:0, scale:0.9 }} animate={{ opacity:1, scale:1 }} transition={{ type:'spring', stiffness:120, damping:18 }} className="relative w-full rounded-3xl border border-slate-700/60 bg-slate-950/70 backdrop-blur-xl p-8 overflow-hidden shadow-2xl shadow-slate-950/50 flex flex-col items-center gap-8" aria-labelledby="spotlight-heading">
          <AnimatedGridBackground />
          <div className="absolute -inset-40 bg-gradient-to-br from-violet-600/30 via-fuchsia-500/30 to-cyan-400/30 blur-3xl opacity-40" />
          <div className="relative z-10 flex flex-col items-center gap-6 w-full">
            {matchCircle}
            <div className="text-center space-y-3">
              <h2 id="spotlight-heading" className="text-4xl font-bold tracking-tight text-slate-100">{data.name}</h2>
              <div className="flex flex-wrap gap-2 justify-center" aria-label="Metryki">
                <Badge variant="outline" className="border-violet-500/40 text-violet-300">Trend {data.trend}%</Badge>
                <Badge variant="outline" className="border-emerald-500/40 text-emerald-300">Czas {data.time}m</Badge>
                <Badge variant="outline" className="border-cyan-500/40 text-cyan-300">Zarobki {data.salary}</Badge>
              </div>
            </div>
            <div className="grid grid-cols-3 gap-6 w-full max-w-xl pt-2" aria-label="Najmocniejsze czynniki">
              {Object.entries(result.factors).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v],i) => (
                <motion.div key={k} initial={{ opacity:0, y:20 }} animate={{ opacity:1, y:0 }} transition={{ delay:.05*i }} className="flex flex-col items-center gap-2 group">
                  <div className="relative h-16 w-16 rounded-full bg-slate-900/70 border border-slate-700/60 flex items-center justify-center overflow-hidden">
                    <div className="absolute inset-0 opacity-0 group-hover:opacity-100 bg-gradient-to-br from-violet-600/40 to-cyan-400/40 transition" />
                    <span className="text-sm font-semibold bg-gradient-to-r from-emerald-400 via-violet-400 to-cyan-400 bg-clip-text text-transparent">{pct(v)}%</span>
                  </div>
                  <Tooltip label={labelFactor(k)}><span className="text-[11px] uppercase tracking-wide text-slate-400 text-center leading-tight cursor-help">{labelFactor(k)}</span></Tooltip>
                </motion.div>
              ))}
            </div>
            <div className="flex flex-wrap gap-3 pt-2" aria-label="Akcje">
              <Button onClick={onAccept} className="bg-emerald-600 hover:bg-emerald-500 gap-2 focus:ring-2 focus:ring-emerald-400/40">Akceptuj <Check className="w-4 h-4" /></Button>
              <Button variant="outline" onClick={onSave} className="gap-2 border-violet-500/40 text-violet-300 hover:bg-violet-500/10 focus:ring-2 focus:ring-violet-400/40">Zapisz <Save className="w-4 h-4" /></Button>
              <Button variant="outline" onClick={onReject} className="gap-2 border-red-500/40 text-red-300 hover:bg-red-500/10 focus:ring-2 focus:ring-red-400/40">Odrzuć <X className="w-4 h-4" /></Button>
              <Button variant="outline" onClick={toSwipe} className="gap-2 border-cyan-500/40 text-cyan-300 hover:bg-cyan-500/10 focus:ring-2 focus:ring-cyan-400/40">Swipe <Flame className="w-4 h-4" /></Button>
              <Button variant="outline" onClick={toDashboard} className="gap-2 border-emerald-500/40 text-emerald-300 hover:bg-emerald-500/10 focus:ring-2 focus:ring-emerald-400/40">Dashboard <LayoutGrid className="w-4 h-4" /></Button>
            </div>
          </div>
        </motion.div>
        <div className="mt-10 w-full max-w-5xl grid grid-cols-2 md:grid-cols-4 gap-4" aria-label="Korzyści">
          {benefits.map((b,i) => (
            <motion.div key={b.key} initial={{ opacity:0, y:24 }} whileInView={{ opacity:1, y:0 }} viewport={{ once:true }} transition={{ delay:0.05*i }} className="relative p-4 rounded-2xl border border-slate-700/60 bg-slate-900/60 backdrop-blur group overflow-hidden focus-within:ring-2 focus-within:ring-violet-400/40" tabIndex={0} aria-label={b.label}>
              <div className="absolute inset-0 opacity-0 group-hover:opacity-25 transition bg-gradient-to-br from-violet-600/30 via-fuchsia-500/30 to-cyan-400/30" />
              <div className="relative z-10 flex flex-col items-start gap-3">
                <div className="h-10 w-10 rounded-xl bg-slate-800/70 flex items-center justify-center text-emerald-300">{b.icon}</div>
                <div className="text-xs font-medium text-slate-200 leading-tight">{b.label}</div>
              </div>
            </motion.div>
          ))}
        </div>
      </div>
      {/* Prawy panel */}
      <aside className="hidden xl:flex col-span-3 flex-col gap-4" aria-label="Kontekst">
        <Card className="border-slate-700/60 bg-slate-950/60 p-5">
          <div className="text-xs font-semibold tracking-wide uppercase text-slate-400 mb-3 flex items-center gap-2"><Target className="w-4 h-4 text-emerald-400" /> Następne kroki</div>
          <ul className="space-y-2 text-[11px] text-slate-400 list-disc list-inside">
            <li>Spróbuj trybu porównania (C)</li>
            <li>Zweryfikuj rynek (K)</li>
            <li>Poszerz alternatywy (Swipe)</li>
          </ul>
        </Card>
        <Card className="border-slate-700/60 bg-slate-950/60 p-5">
          <div className="text-xs font-semibold tracking-wide uppercase text-slate-400 mb-3 flex items-center gap-2"><Lightbulb className="w-4 h-4 text-amber-400" /> Fokus UX</div>
          <p className="text-[11px] text-slate-500 leading-relaxed">Centralny spotlight redukuje przeciążenie wyboru i wzmacnia intencję decyzji (akceptuj / zapisz / odłóż). Boczny panel kieruje uwagę na działania poprawiające jakość algorytmiczną.</p>
        </Card>
      </aside>
    </div>
  );
}

function HeroSection({ data, onStart, onGoSwipe }) {
  const [animMatch, setAnimMatch] = useState(0);
  useEffect(()=>{
    let frame; let start;
    const duration = 1100; const target = data.matchPct;
    const ease = (t)=>1-Math.pow(1-t,3);
    const step=(ts)=>{ if (!start) start=ts; const p = Math.min(1,(ts-start)/duration); setAnimMatch(Math.round(target*ease(p))); if(p<1) frame=requestAnimationFrame(step); };
    frame=requestAnimationFrame(step); return ()=>cancelAnimationFrame(frame);
  }, [data.matchPct]);

  return (
    <section className="relative rounded-3xl overflow-hidden border border-slate-700/60 bg-slate-950/60 backdrop-blur-xl shadow-2xl shadow-slate-950/50 p-6 md:p-10">
      <div className="absolute -inset-40 opacity-40 bg-gradient-to-br from-violet-600/30 via-fuchsia-500/30 to-cyan-400/30 blur-3xl" />
      <div className="relative z-10 grid gap-10 lg:grid-cols-[1.1fr,0.9fr] items-start">
        <div className="space-y-6">
          <div className="inline-flex items-center gap-2 rounded-full bg-slate-800/70 border border-slate-700/60 px-3 py-1 text-emerald-300 text-xs">
            <Sparkles className="w-4 h-4" /> PERSONALIZOWANE DLA CIEBIE
          </div>
          <h2 className="text-4xl md:text-5xl font-bold tracking-tight text-slate-100">{data.name}</h2>
          <p className="text-base md:text-lg text-slate-300 leading-relaxed">{data.explanation}</p>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 pt-2">
            <MetricBox label="Dopasowanie" value={`${animMatch}%`} icon={<CheckCircle2 className="w-4 h-4 text-emerald-400" />} />
            <MetricBox label="Trend" value={`${data.trend}%`} icon={<TrendingPill value={data.trend} />} />
            <MetricBox label="Zarobki" value={data.salary} icon={<BarChart3 className="w-4 h-4 text-violet-400" />} />
            <MetricBox label="Czas" value={`${data.time} mies.`} icon={<Clock className="w-4 h-4 text-cyan-400" />} />
          </div>
          <div className="flex flex-wrap gap-3 pt-4">
            <Button onClick={onStart} className="bg-emerald-600 hover:bg-emerald-500 gap-2">Rozpocznij <Rocket className="w-4 h-4" /></Button>
            <Button variant="outline" onClick={onGoSwipe} className="gap-2 border-violet-500/40 text-violet-300 hover:bg-violet-500/10">Eksploruj (Swipe) <Flame className="w-4 h-4" /></Button>
            <Button variant="outline" className="gap-2 border-cyan-500/40 text-cyan-300 hover:bg-cyan-500/10">Porównaj <LayoutGrid className="w-4 h-4" /></Button>
          </div>
        </div>
        <div className="space-y-6">
          <FactorHeatmap factors={data.factors} />
          <ExplainBlock text={data.explanation} />
        </div>
      </div>
    </section>
  );
}

function MetricBox({ label, value, icon }) {
  return (
    <div className="relative rounded-xl border border-slate-700/60 bg-slate-900/60 backdrop-blur p-3 flex flex-col gap-1">
      <div className="flex items-center gap-2 text-[11px] tracking-wide uppercase text-slate-400">{icon} {label}</div>
      <div className="text-lg font-semibold text-slate-100 tabular-nums">{value}</div>
      <div className="absolute -inset-px rounded-xl ring-1 ring-slate-700/60 pointer-events-none" />
    </div>
  );
}

function TrendingPill({ value }) {
  const c = value > 60 ? 'text-emerald-400' : value > 40 ? 'text-violet-400' : 'text-slate-400';
  return <Activity className={`w-4 h-4 ${c}`} />;
}

function ExplainBlock({ text }) {
  return (
    <Card className="border-slate-700/60 bg-slate-900/60">
      <CardHeader className="pb-2">
        <CardTitle className="text-sm font-medium flex items-center gap-2 text-slate-300"><Lightbulb className="w-4 h-4 text-amber-400" /> Dlaczego to pasuje</CardTitle>
      </CardHeader>
      <CardContent className="pt-0 text-sm leading-relaxed text-slate-400">
        {text}
      </CardContent>
    </Card>
  );
}

function FactorHeatmap({ factors }) {
  const entries = Object.entries(factors || {});
  return (
    <Card className="border-slate-700/60 bg-slate-900/60">
      <CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2 text-slate-300"><ChartSpline className="w-4 h-4 text-cyan-400" /> Czynniki</CardTitle></CardHeader>
      <CardContent className="pt-1 space-y-3">
        {entries.map(([k,v]) => (
          <div key={k} className="flex items-center gap-3">
            <span className="w-28 text-xs text-slate-400 truncate">{labelFactor(k)}</span>
            <div className="flex-1 h-2 relative rounded-full overflow-hidden bg-slate-800/80">
              <div className="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400" style={{ width: pct(v)+'%' }} />
            </div>
            <span className="w-10 text-right text-xs tabular-nums text-slate-300">{pct(v)}%</span>
          </div>
        ))}
      </CardContent>
    </Card>
  );
}

// ----------------------------- SwipeDeck ----------------------------- //

function SwipeDeck({ results, deckIds, current, onDecision, decisions }) {
  const progress = deckIds.length ? 100 - Math.round(deckIds.length / results.length * 100) : 100;
  return (
    <div className="relative min-h-[560px] flex flex-col gap-6">
      <div className="flex items-center justify-between">
        <h3 className="text-xl font-semibold tracking-tight flex items-center gap-2"><Flame className="w-5 h-5 text-emerald-400" /> Tryb eksploracji (Swipe)</h3>
        <div className="w-56"><Progress value={progress} /></div>
      </div>
      <div className="flex-1 relative">
        <AnimatePresence initial={false} mode="wait">
          {current ? (
            <SwipeCard key={current.career.id} result={current} onDecision={onDecision} decisions={decisions} />
          ) : (
            <motion.div key="done" initial={{opacity:0}} animate={{opacity:1}} className="absolute inset-0 flex flex-col items-center justify-center gap-4">
              <div className="text-3xl font-bold bg-gradient-to-r from-emerald-400 via-violet-400 to-cyan-400 bg-clip-text text-transparent">Koniec talii</div>
              <p className="text-slate-400 text-sm">Przejrzałeś wszystkie dostępne role na tę chwilę.</p>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  );
}

function SwipeCard({ result, onDecision, decisions }) {
  const { career, score, factors } = result;
  const [dragging, setDragging] = useState(false);
  const gradient = pickGradientFor(career.id);
  const decisionFor = (id) => decisions.accepted.includes(id) ? 'accepted' : decisions.rejected.includes(id) ? 'rejected' : decisions.saved.includes(id) ? 'saved' : null;
  const state = decisionFor(career.id);

  return (
    <motion.div
      className="absolute inset-0 flex items-center justify-center"
      initial={{ opacity:0, y:40, scale:0.95 }}
      animate={{ opacity:1, y:0, scale:1 }}
      exit={{ opacity:0, y:-40, scale:0.9 }}
      transition={{ type:'spring', stiffness:140, damping:22 }}
    >
      <motion.div
        drag="x"
        dragElastic={0.5}
        dragConstraints={{ left:0, right:0 }}
        onDragStart={()=>setDragging(true)}
        onDragEnd={(e,info)=>{ setDragging(false); if (info.offset.x>140) onDecision(career.id,'accept'); else if (info.offset.x<-140) onDecision(career.id,'reject'); }}
        whileTap={{ cursor:'grabbing' }}
        className="w-full max-w-2xl"
      >
        <Card className="relative overflow-hidden border border-slate-700/60 bg-slate-950/70 backdrop-blur-xl shadow-xl shadow-slate-950/50">
          <div className={`absolute -inset-40 opacity-25 bg-gradient-to-br ${gradient} blur-3xl`} />
            <CardHeader className="relative z-10 pb-4">
              <CardTitle className="flex items-center gap-3">
                <span className="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-slate-800/70 ring-2 ring-slate-600/40 text-slate-200 text-lg font-semibold">{emojiFor(career.id)}</span>
                <span className="text-2xl font-bold tracking-tight text-slate-100">{career.name}</span>
              </CardTitle>
            </CardHeader>
            <CardContent className="relative z-10 space-y-8">
              <div className="grid md:grid-cols-5 gap-6">
                <div className="md:col-span-3 space-y-6">
                  <div>
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-slate-400">Dopasowanie</span>
                      <span className="text-3xl font-bold tabular-nums bg-gradient-to-r from-emerald-400 to-cyan-300 bg-clip-text text-transparent">{pct(score)}%</span>
                    </div>
                    <Progress value={pct(score)} />
                  </div>
                  <MiniFactors factors={factors} />
                  <div className="flex flex-wrap gap-2 pt-2">
                    {Object.keys(career.requiredSkills).slice(0,6).map(s => (
                      <Badge key={s} variant="outline" className="border-slate-600/60 bg-slate-800/60 text-slate-300 text-[11px]">{s}</Badge>
                    ))}
                  </div>
                  <div className="flex flex-col sm:flex-row gap-3">
                    <Button onClick={()=>onDecision(career.id,'accept')} className="flex-1 bg-emerald-600 hover:bg-emerald-500 gap-2"><Check className="w-4 h-4" /> Akceptuj</Button>
                    <Button variant="outline" onClick={()=>onDecision(career.id,'save')} className="flex-1 border-violet-500/40 text-violet-300 hover:bg-violet-500/10 gap-2"><Save className="w-4 h-4" /> Zapisz</Button>
                    <Button variant="outline" onClick={()=>onDecision(career.id,'reject')} className="flex-1 border-red-500/40 text-red-300 hover:bg-red-500/10 gap-2"><X className="w-4 h-4" /> Odrzuć</Button>
                  </div>
                </div>
                <div className="md:col-span-2 space-y-4 text-sm text-slate-300">
                  <div className="rounded-xl border border-slate-700/60 bg-slate-900/60 p-4">
                    <h4 className="text-xs font-semibold tracking-wide text-slate-400 mb-2 flex items-center gap-1"><Info className="w-3.5 h-3.5" /> Rynek</h4>
                    <ul className="space-y-1 text-[13px]">
                      <li>Trend: {Math.round(((career.market?.trend||0)+0.5)*100)}%</li>
                      <li>Remote: {Math.round((career.market?.remoteAvailability||0)*100)}%</li>
                      <li>Volatility: {pct(1-(career.market?.volatility||0.5))}% stabilność</li>
                      <li>Zarobki: {career.salaryK? `${career.salaryK[0]}–${career.salaryK[1]}k`:'n/d'}</li>
                    </ul>
                  </div>
                  <div className="rounded-xl border border-slate-700/60 bg-slate-900/60 p-4">
                    <h4 className="text-xs font-semibold tracking-wide text-slate-400 mb-2 flex items-center gap-1"><Compass className="w-3.5 h-3.5" /> Potencjał</h4>
                    <ul className="space-y-1 text-[13px]">
                      <li>Ścieżka: {derivePaths(career.id).join(' → ')}</li>
                      <li>Czas do mid: ~{estimateTimeMonths(career.id)} mies.</li>
                      <li>Wartości: {(career.market?.values||[]).slice(0,3).join(', ') || '—'}</li>
                    </ul>
                  </div>
                </div>
              </div>
              {state && <div className="text-center text-xs text-slate-400">Status: {state}</div>}
              <motion.div className="pointer-events-none absolute inset-0" animate={{ opacity: dragging?0.35:0.18 }}>
                <div className={`absolute -inset-40 bg-gradient-to-tr ${gradient} blur-3xl`} />
              </motion.div>
            </CardContent>
        </Card>
      </motion.div>
    </motion.div>
  );
}

function MiniFactors({ factors }) {
  const ordered = Object.entries(factors).sort((a,b)=>b[1]-a[1]).slice(0,4);
  return (
    <div className="grid grid-cols-2 gap-3">
      {ordered.map(([k,v]) => (
        <div key={k} className="space-y-1">
          <div className="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400">
            <span>{labelFactor(k)}</span>
            <span className="tabular-nums text-slate-300">{pct(v)}%</span>
          </div>
          <div className="h-1.5 w-full bg-slate-800/80 rounded-full overflow-hidden">
            <div className="h-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400" style={{ width: pct(v)+'%' }} />
          </div>
        </div>
      ))}
    </div>
  );
}

// ----------------------------- DashboardView ----------------------------- //

function DashboardView({ results, decisions, onAccept, onReject, onSave, onSelect }) {
  return (
    <div className="space-y-6">
      <h3 className="text-xl font-semibold tracking-tight flex items-center gap-2"><LayoutGrid className="w-5 h-5 text-cyan-400" /> Dashboard dopasowań</h3>
      <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {results.map(r => (
          <DashboardCard
            key={r.career.id}
            result={r}
            decisions={decisions}
            onAccept={onAccept}
            onReject={onReject}
            onSave={onSave}
            onSelect={onSelect}
          />
        ))}
      </div>
    </div>
  );
}

function DashboardCard({ result, decisions, onAccept, onReject, onSave, onSelect }) {
  const { career, score } = result;
  const gradient = pickGradientFor(career.id);
  const state = decisions.accepted.includes(career.id) ? 'accepted' : decisions.rejected.includes(career.id) ? 'rejected' : decisions.saved.includes(career.id) ? 'saved' : null;
  return (
    <motion.div
      initial={{ opacity:0, y:20 }}
      animate={{ opacity:1, y:0 }}
      whileHover={{ y:-4 }}
      transition={{ duration:0.35 }}
      className="group"
    >
      <Card className="relative overflow-hidden border border-slate-700/60 bg-slate-950/60 backdrop-blur-xl h-full flex flex-col">
        <div className={`absolute -inset-40 opacity-20 bg-gradient-to-br ${gradient} blur-3xl transition-opacity group-hover:opacity-30`} />
        <CardHeader className="relative z-10 pb-3">
          <CardTitle className="flex items-center gap-2 text-base font-semibold text-slate-100">
            <span className="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-slate-800/70 text-sm ring-1 ring-slate-600/50">{emojiFor(career.id)}</span>
            <span className="truncate" title={career.name}>{career.name}</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="relative z-10 pt-0 flex flex-col gap-4 flex-1">
          <div>
            <div className="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400 mb-1">
              <span>Dopasowanie</span>
              <span className="tabular-nums text-slate-300">{pct(score)}%</span>
            </div>
            <Progress value={pct(score)} />
          </div>
          <div className="grid grid-cols-3 gap-2">
            <TinyMetric label="Trend" value={Math.round(((career.market?.trend||0)+0.5)*100)+'%'} />
            <TinyMetric label="Remote" value={Math.round((career.market?.remoteAvailability||0)*100)+'%'} />
            <TinyMetric label="Sal" value={career.salaryK? career.salaryK[1]+'k':'n/d'} />
          </div>
          <div className="flex flex-wrap gap-1 mt-auto">
            {Object.keys(career.requiredSkills).slice(0,4).map(s => <span key={s} className="px-1.5 py-0.5 rounded-md bg-slate-800/60 border border-slate-700/60 text-[10px] text-slate-300">{s}</span>)}
          </div>
          <div className="flex flex-col gap-2 pt-2">
            <div className="flex gap-2">
              <Button size="sm" onClick={()=>onAccept(career.id)} className="flex-1 bg-emerald-600 hover:bg-emerald-500">Akceptuj</Button>
              <Button size="sm" variant="outline" onClick={()=>onSave(career.id)} className="flex-1 border-violet-500/40 text-violet-300 hover:bg-violet-500/10">Zapisz</Button>
            </div>
            <div className="flex gap-2">
              <Button size="sm" variant="outline" onClick={()=>onReject(career.id)} className="flex-1 border-red-500/40 text-red-300 hover:bg-red-500/10">Odrzuć</Button>
              <Button size="sm" variant="outline" onClick={()=>onSelect(career.id)} className="flex-1 border-cyan-500/40 text-cyan-300 hover:bg-cyan-500/10">Ścieżka</Button>
            </div>
          </div>
          {state && <div className="text-[10px] text-center text-slate-400 mt-1">Status: {state}</div>}
        </CardContent>
      </Card>
    </motion.div>
  );
}

function TinyMetric({ label, value }) {
  return (
    <div className="p-2 rounded-lg bg-slate-900/60 border border-slate-700/60 flex flex-col gap-1">
      <span className="text-[9px] uppercase tracking-wide text-slate-500">{label}</span>
      <span className="text-[11px] font-medium text-slate-300 tabular-nums">{value}</span>
    </div>
  );
}

// ----------------------------- StoryMode ----------------------------- //

function StoryMode({ results, index, onNext, onPrev, onAccept, onReject, onSave }) {
  const current = results[index];
  const done = index >= results.length-1;
  return (
    <div className="space-y-8">
      <div className="flex items-center justify-between">
        <h3 className="text-xl font-semibold tracking-tight flex items-center gap-2"><BookOpen className="w-5 h-5 text-amber-400" /> Tryb narracyjny</h3>
        <div className="text-xs text-slate-400">{index+1} / {results.length}</div>
      </div>
      <AnimatePresence mode="wait" initial={false}>
        <motion.div
          key={current.career.id}
          initial={{ opacity:0, x:40 }}
          animate={{ opacity:1, x:0 }}
          exit={{ opacity:0, x:-40 }}
          transition={{ duration:0.45, ease:'easeOut' }}
          className="rounded-3xl border border-slate-700/60 bg-slate-950/60 backdrop-blur-xl p-8 relative overflow-hidden"
        >
          <div className="absolute -inset-40 bg-gradient-to-br from-amber-500/20 via-pink-500/20 to-violet-500/20 blur-3xl opacity-40" />
          <div className="relative z-10 space-y-6">
            <div className="flex items-center gap-4">
              <div className="h-14 w-14 rounded-2xl bg-slate-800/70 ring-2 ring-slate-600/50 flex items-center justify-center text-xl">{emojiFor(current.career.id)}</div>
              <div>
                <h4 className="text-2xl font-bold tracking-tight text-slate-100">{current.career.name}</h4>
                <div className="text-sm text-slate-400">Dopasowanie {pct(current.score)}%</div>
              </div>
            </div>
            <p className="text-slate-300 text-sm leading-relaxed max-w-3xl">{buildReadableInsight(current)}. Ta rola może prowadzić do: {derivePaths(current.career.id).join(', ')}. Szacowany czas do mid-level: {estimateTimeMonths(current.career.id)} mies. – Twoje najmocniejsze filary to {Object.entries(current.factors).sort((a,b)=>b[1]-a[1]).slice(0,2).map(([k])=>labelFactor(k)).join(' i ')}.</p>
            <div className="grid md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <h5 className="text-xs font-semibold tracking-wide uppercase text-slate-400">Kluczowe umiejętności</h5>
                <div className="flex flex-wrap gap-2">
                  {Object.keys(current.career.requiredSkills).map(s => <span key={s} className="px-2 py-1 rounded-md bg-slate-800/70 border border-slate-700/60 text-[11px] text-slate-300">{s}</span>)}
                </div>
              </div>
              <div className="space-y-4">
                <h5 className="text-xs font-semibold tracking-wide uppercase text-slate-400">Czynniki dopasowania</h5>
                <div className="space-y-2">
                  {Object.entries(current.factors).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v]) => (
                    <div key={k} className="flex items-center gap-2">
                      <div className="w-28 text-[11px] text-slate-400 truncate">{labelFactor(k)}</div>
                      <div className="flex-1 h-2 bg-slate-800/70 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-amber-400 via-pink-500 to-violet-600" style={{ width: pct(v)+'%' }} />
                      </div>
                      <div className="w-10 text-right text-[11px] tabular-nums text-slate-300">{pct(v)}%</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            <div className="flex flex-wrap gap-3 pt-4">
              <Button onClick={()=>onAccept(current.career.id)} className="bg-emerald-600 hover:bg-emerald-500">Akceptuj</Button>
              <Button variant="outline" onClick={()=>onSave(current.career.id)} className="border-violet-500/40 text-violet-300 hover:bg-violet-500/10">Zapisz</Button>
              <Button variant="outline" onClick={()=>onReject(current.career.id)} className="border-red-500/40 text-red-300 hover:bg-red-500/10">Odrzuć</Button>
              <div className="ml-auto flex gap-2">
                <Button variant="outline" disabled={index===0} onClick={onPrev} className="gap-1"><ArrowLeft className="w-4 h-4" /> Poprzednia</Button>
                <Button variant="outline" disabled={done} onClick={onNext} className="gap-1">Następna <ArrowRight className="w-4 h-4" /></Button>
              </div>
            </div>
          </div>
        </motion.div>
      </AnimatePresence>
    </div>
  );
}

// ----------------------------- FooterPanel ----------------------------- //

function FooterPanel({ decisions, results, resetDecisions }) {
  const accepted = results.filter(r => decisions.accepted.includes(r.career.id));
  const saved = results.filter(r => decisions.saved.includes(r.career.id));
  const rejected = results.filter(r => decisions.rejected.includes(r.career.id));
  return (
    <div className="space-y-6 pt-4">
      <div className="rounded-2xl border border-slate-700/60 bg-slate-950/60 backdrop-blur p-6">
        <div className="flex items-center justify-between mb-4">
          <h4 className="text-sm font-semibold tracking-wide text-slate-300 flex items-center gap-2"><Brain className="w-4 h-4 text-violet-400" /> Twoje decyzje</h4>
          <Button variant="outline" onClick={resetDecisions} className="border-red-500/40 text-red-300 hover:bg-red-500/10 gap-1"><Trash2 className="w-4 h-4" /> Reset</Button>
        </div>
        <div className="grid md:grid-cols-3 gap-6 text-sm">
          <DecisionColumn title="Akceptowane" items={accepted} tint="emerald" empty="Brak jeszcze zaakceptowanych." />
          <DecisionColumn title="Zapisane" items={saved} tint="violet" empty="Nic nie zapisano." />
          <DecisionColumn title="Odrzucone" items={rejected} tint="red" empty="Brak odrzuceń." />
        </div>
      </div>
      <div className="text-[10px] text-center text-slate-500">Hotkeys: A akceptuj • R odrzuć • S zapisz • H hero • M zmiana trybu • ←/→ story • Drag swipe</div>
    </div>
  );
}

function DecisionColumn({ title, items, tint, empty }) {
  return (
    <div className="space-y-3">
      <div className="text-xs font-semibold uppercase tracking-wide text-slate-400">{title} ({items.length})</div>
      {items.length === 0 && <div className="text-[11px] text-slate-500">{empty}</div>}
      <div className="flex flex-wrap gap-2">
        {items.map(r => (
          <span key={r.career.id} className={`px-2 py-1 rounded-md text-[11px] border bg-slate-900/60 border-${tint}-500/40 text-${tint}-300`}>{r.career.name}</span>
        ))}
      </div>
    </div>
  );
}

// ----------------------------- Hotkey legend ----------------------------- //

function HotkeyLegend() {
  const HK = [
    ['A','Akceptuj'], ['R','Odrzuć'], ['S','Zapisz'], ['M','Tryb'], ['H','Hero'], ['C','Compare'], ['D','Radar'], ['K','Market'], ['←/→','Story nawig.']
  ];
  return (
    <div className="flex flex-wrap gap-2 text-[10px] text-slate-400">
      {HK.map(([k,l]) => (
        <span key={k} className="px-2 py-1 rounded-md bg-slate-900/70 border border-slate-700/60">{k} <span className="text-slate-500 ml-1">{l}</span></span>
      ))}
    </div>
  );
}

// ----------------------------- Utility (paths & emoji) ----------------------------- //

function derivePaths(id) {
  switch(id) {
    case 'frontend_dev': return ['Full‑Stack','Product Engineer','Tech Lead'];
    case 'backend_dev': return ['Platform','Architect','Tech Lead'];
    case 'data_analyst': return ['Analytics Eng','Data Science','BI Lead'];
    case 'ux_designer': return ['Product Designer','Design Lead','Research'];
    case 'project_manager': return ['Product Manager','Delivery Lead','Program Manager'];
    default: return ['Growth','Specjalizacja'];
  }
}

function emojiFor(id) {
  if (id==='frontend_dev') return '💻';
  if (id==='backend_dev') return '🧠';
  if (id==='data_analyst') return '📊';
  if (id==='ux_designer') return '🎨';
  if (id==='project_manager') return '📅';
  return '🎯';
}

// ======================= NOWE TRYBY / KOMPONENTY DODATKOWE ======================= //

// Compare Mode
function CompareMode({ results, decisions, onAccept, onReject, onSave }) {
  const top = results.slice(0,50);
  const [selected, setSelected] = useState(()=> top.slice(0,3).map(r=>r.career.id));
  const toggle = (id) => setSelected(sel=> sel.includes(id) ? sel.filter(x=>x!==id) : sel.length<5 ? [...sel,id] : sel);
  return (
    <div className="space-y-10" aria-label="Tryb porównania">
      <div className="flex items-center justify-between">
        <h3 className="text-xl font-semibold tracking-tight flex items-center gap-2"><BarChart3 className="w-5 h-5 text-violet-400" /> Tryb porównania</h3>
        <div className="text-xs text-slate-400">Zaznacz do 5 ról</div>
      </div>
      <div className="grid lg:grid-cols-[1fr,0.9fr] gap-10">
        <CompareSelectableList results={top} selected={selected} toggle={toggle} />
        <div className="space-y-6">
          <CompareRadarPanel results={results.filter(r=>selected.includes(r.career.id))} />
          <CompareBarFactors results={results.filter(r=>selected.includes(r.career.id))} />
        </div>
      </div>
    </div>
  );
}

function CompareSelectableList({ results, selected, toggle }) {
  return (
    <div className="rounded-2xl border border-slate-700/60 bg-slate-950/60 backdrop-blur p-4 space-y-4">
      <div className="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
        {results.slice(0,18).map(r => {
          const active = selected.includes(r.career.id);
          return (
            <button key={r.career.id} onClick={()=>toggle(r.career.id)} className={`group relative flex flex-col items-start gap-2 p-4 rounded-xl border transition overflow-hidden text-left focus:outline-none focus:ring-2 focus:ring-violet-400/50 ${active? 'border-violet-500/60 bg-slate-900/70 shadow-[0_0_0_1px_rgba(139,92,246,.3)]':'border-slate-700/60 bg-slate-900/50 hover:border-slate-600/60'}`}> 
              <div className="absolute inset-0 opacity-0 group-hover:opacity-20 bg-gradient-to-br from-violet-600/30 via-fuchsia-500/30 to-cyan-400/30 transition" />
              <div className="relative z-10 flex items-center gap-3 w-full">
                <span className="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-slate-800/70 text-sm ring-1 ring-slate-600/50">{emojiFor(r.career.id)}</span>
                <span className="text-[13px] font-medium text-slate-200 truncate" title={r.career.name}>{r.career.name}</span>
                <span className="ml-auto text-[11px] tabular-nums text-slate-400">{pct(r.score)}%</span>
              </div>
              <div className="relative z-10 w-full h-1.5 rounded-full bg-slate-800 overflow-hidden">
                <div className="h-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400" style={{ width: pct(r.score)+'%' }} />
              </div>
              {active && <span className="absolute top-2 right-2 inline-flex h-5 w-5 items-center justify-center rounded-full bg-violet-600 text-[10px] text-white">{selected.indexOf(r.career.id)+1}</span>}
            </button>
          );
        })}
      </div>
    </div>
  );
}

function CompareRadarPanel({ results }) {
  if (!results.length) return null;
  const factorKeys = ['skills','personality','interests','salary','values','market','location'];
  return (
    <Card className="border-slate-700/60 bg-slate-900/60">
      <CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2 text-slate-300"><Gauge className="w-4 h-4 text-cyan-400" /> Radar dopasowania</CardTitle></CardHeader>
      <CardContent className="pt-2">
        <RadarChartSVG results={results} factors={factorKeys} />
        <div className="mt-4 flex flex-wrap gap-2 text-[10px]">
          {results.map((r,i)=> (
            <span key={r.career.id} className="px-2 py-1 rounded-md border border-slate-700/60 bg-slate-800/60 flex items-center gap-1" style={{ '--c': radarColor(i) }}>
              <span className="inline-block h-2 w-2 rounded-full" style={{ background: `var(--c)` }} /> {r.career.name}
            </span>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}

function RadarChartSVG({ results, factors }) {
  const size = 300; const center = size/2; const radius = 120; const angleStep = (Math.PI*2)/factors.length;
  function point(val, idx) {
    const a = idx * angleStep - Math.PI/2;
    const r = radius * clamp(val,0,1);
    return [center + r * Math.cos(a), center + r * Math.sin(a)];
  }
  return (
    <div className="relative" style={{ width:size, height:size }}>
      <svg viewBox={`0 0 ${size} ${size}`} className="mx-auto">
        {[0.25,0.5,0.75,1].map(g => (<circle key={g} cx={center} cy={center} r={radius*g} className="fill-none stroke-slate-700/40" strokeWidth={1} />))}
        {factors.map((f,i)=>{ const a=i*angleStep - Math.PI/2; const x=center+radius*Math.cos(a); const y=center+radius*Math.sin(a); return <line key={f} x1={center} y1={center} x2={x} y2={y} stroke="rgba(100,116,139,0.4)" strokeWidth={1} />; })}
        {results.map((r,ri)=>{
          const pts = factors.map((f,i)=> point(r.factors[f]||0,i));
            const d = pts.map((p,i)=> `${i===0?'M':'L'}${p[0]},${p[1]}`).join(' ') + ' Z';
            return (
              <g key={r.career.id} style={{ '--c': radarColor(ri) }}>
                <path d={d} fill={`var(--c)`} fillOpacity={0.15} stroke={`var(--c)`} strokeWidth={2} />
                {pts.map((p,i)=>(<circle key={i} cx={p[0]} cy={p[1]} r={3.5} fill={`var(--c)`} stroke="rgba(255,255,255,0.4)" strokeWidth={1} />))}
              </g>
            );
        })}
        {factors.map((f,i)=>{ const [x,y]= point(1.12, i); return <text key={f} x={x} y={y} className="text-[10px] fill-slate-400 font-medium" textAnchor="middle" dominantBaseline="middle">{labelFactor(f)}</text>; })}
      </svg>
    </div>
  );
}

function radarColor(i) { const palette = ['#8b5cf6','#06b6d4','#10b981','#f59e0b','#ec4899']; return palette[i % palette.length]; }

function CompareBarFactors({ results }) {
  if (!results.length) return null;
  const factorKeys = ['skills','personality','interests','salary','values','market','location'];
  const aggregates = factorKeys.map(k => { const arr = results.map(r=> r.factors[k]||0); const avg = arr.reduce((a,b)=>a+b,0)/arr.length; return { key:k, avg }; });
  return (
    <Card className="border-slate-700/60 bg-slate-900/60">
      <CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2 text-slate-300"><BarChart2 className="w-4 h-4 text-emerald-400" /> Średnie czynniki</CardTitle></CardHeader>
      <CardContent className="pt-1 space-y-3">
        {aggregates.map(a => (
          <div key={a.key} className="flex items-center gap-3">
            <span className="w-28 text-[11px] text-slate-400 truncate">{labelFactor(a.key)}</span>
            <div className="flex-1 h-2 relative rounded-full overflow-hidden bg-slate-800/80">
              <div className="absolute inset-y-0 left-0 rounded-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400" style={{ width: pct(a.avg)+'%' }} />
            </div>
            <span className="w-10 text-right text-[11px] tabular-nums text-slate-300">{pct(a.avg)}%</span>
          </div>
        ))}
      </CardContent>
    </Card>
  );
}

// Market Mode
function MarketMode({ results, onAccept, onReject, onSave, decisions }) {
  const top = results.slice(0,60);
  return (
    <div className="space-y-8" aria-label="Tryb rynek">
      <div className="flex items-center justify-between">
        <h3 className="text-xl font-semibold tracking-tight flex items-center gap-2"><Landmark className="w-5 h-5 text-emerald-400" /> Pozycja rynkowa</h3>
        <div className="text-xs text-slate-400">Trend ↑ | Stabilność ↑</div>
      </div>
      <Card className="border-slate-700/60 bg-slate-950/60 p-4">
        <MarketMatrix results={top} />
      </Card>
      <div className="grid md:grid-cols-3 gap-6">
        {top.slice(0,9).map(r => <MarketCard key={r.career.id} result={r} onAccept={onAccept} onReject={onReject} onSave={onSave} decisions={decisions} />)}
      </div>
    </div>
  );
}

function MarketMatrix({ results }) {
  const size = 480; const pad = 40;
  const items = results.map(r => { const t=(r.career.market?.trend||0)+0.5; const stability = 1 - (r.career.market?.volatility||0.5); return { id:r.career.id, name:r.career.name, t, stability, score:r.score }; });
  return (
    <div className="w-full overflow-x-auto">
      <div className="mx-auto" style={{ width:size, height:size }}>
        <svg viewBox={`0 0 ${size} ${size}`} className="w-full h-full">
          <defs>
            <linearGradient id="gradBg" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0%" stopColor="#0f172a" />
              <stop offset="100%" stopColor="#1e293b" />
            </linearGradient>
          </defs>
          <rect x={0} y={0} width={size} height={size} fill="url(#gradBg)" rx={12} />
          {Array.from({length:5}).map((_,i)=>{ const y=pad+((size-2*pad)/4*i); return <line key={'h'+i} x1={pad} x2={size-pad} y1={y} y2={y} stroke="rgba(100,116,139,0.25)" strokeWidth={1} />; })}
          {Array.from({length:5}).map((_,i)=>{ const x=pad+((size-2*pad)/4*i); return <line key={'v'+i} y1={pad} y2={size-pad} x1={x} x2={x} stroke="rgba(100,116,139,0.25)" strokeWidth={1} />; })}
          <text x={size/2} y={18} textAnchor="middle" className="fill-slate-400 text-[12px]">Trend</text>
          <text x={12} y={size/2} textAnchor="middle" transform={`rotate(-90 12 ${size/2})`} className="fill-slate-400 text-[12px]">Stabilność</text>
          {items.map((it,i)=>{ const x=pad+it.t*(size-2*pad); const y=(size-pad)-it.stability*(size-2*pad); const c=radarColor(i); return (
            <g key={it.id} transform={`translate(${x},${y})`}>
              <circle r={10 + pct(it.score)/14} fill={c} fillOpacity={0.22} stroke={c} strokeWidth={1.5} />
              <text y={-16 - (pct(it.score)/14)} textAnchor="middle" className="fill-slate-300 text-[9px] font-medium pointer-events-none">{it.name}</text>
              <title>{it.name} – Trend {pct(it.t)}% • Stabilność {pct(it.stability)}% • Dopasowanie {pct(it.score)}%</title>
            </g>
          ); })}
        </svg>
      </div>
    </div>
  );
}

function MarketCard({ result, onAccept, onReject, onSave, decisions }) {
  const { career, score } = result;
  const state = decisions.accepted.includes(career.id) ? 'accepted' : decisions.rejected.includes(career.id) ? 'rejected' : decisions.saved.includes(career.id) ? 'saved' : null;
  return (
    <Card className="relative overflow-hidden border border-slate-700/60 bg-slate-950/60 backdrop-blur group">
      <div className="absolute inset-0 opacity-0 group-hover:opacity-25 transition bg-gradient-to-br from-emerald-600/30 via-cyan-500/30 to-violet-600/30" />
      <CardHeader className="relative z-10 pb-3">
        <CardTitle className="flex items-center gap-3 text-base font-semibold text-slate-100">
          <span className="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-slate-800/70 ring-1 ring-slate-600/50 text-base">{emojiFor(career.id)}</span>
          <span className="truncate" title={career.name}>{career.name}</span>
        </CardTitle>
      </CardHeader>
      <CardContent className="relative z-10 space-y-4 pt-0 text-sm">
        <div>
          <div className="flex items-center justify-between text-[11px] uppercase tracking-wide text-slate-400 mb-1"><span>Dopas.</span><span className="tabular-nums text-slate-300">{pct(score)}%</span></div>
          <Progress value={pct(score)} />
        </div>
        <div className="grid grid-cols-3 gap-2">
          <TinyMetric label="Trend" value={Math.round(((career.market?.trend||0)+0.5)*100)+'%'} />
          <TinyMetric label="Stab" value={pct(1-(career.market?.volatility||0.5))+'%'} />
          <TinyMetric label="Remote" value={Math.round((career.market?.remoteAvailability||0)*100)+'%'} />
        </div>
        <div className="flex flex-wrap gap-1">{(career.market?.values||[]).slice(0,3).map(v => <span key={v} className="px-1.5 py-0.5 rounded-md bg-slate-800/60 border border-slate-700/60 text-[10px] text-slate-300">{v}</span>)}</div>
        <div className="flex gap-2 pt-1">
          <Button size="sm" onClick={()=>onAccept(career.id)} className="flex-1 bg-emerald-600 hover:bg-emerald-500">Akceptuj</Button>
          <Button size="sm" variant="outline" onClick={()=>onSave(career.id)} className="flex-1 border-violet-500/40 text-violet-300 hover:bg-violet-500/10">Zapisz</Button>
          <Button size="sm" variant="outline" onClick={()=>onReject(career.id)} className="flex-1 border-red-500/40 text-red-300 hover:bg-red-500/10">X</Button>
        </div>
        {state && <div className="text-[10px] text-center text-slate-500">{state}</div>}
      </CardContent>
    </Card>
  );
}

// Mini wizualizacja w Spotlight
function MarketMiniViz({ factor=0, trend=0 }) {
  const stability = 1 - factor;
  const bars = [
    { label:'Trend', value: trend/100 },
    { label:'Stabilność', value: stability },
    { label:'Ogół', value: (trend/100 + stability)/2 }
  ];
  return (
    <div className="absolute inset-0 p-3 flex flex-col gap-3">
      {bars.map(b => (
        <div key={b.label} className="space-y-1">
          <div className="flex items-center justify-between text-[10px] text-slate-400"><span>{b.label}</span><span className="tabular-nums text-slate-300">{pct(b.value)}%</span></div>
          <div className="h-1.5 rounded-full bg-slate-800 overflow-hidden"><div className="h-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400" style={{ width: pct(b.value)+'%' }} /></div>
        </div>
      ))}
    </div>
  );
}

// Tooltip
function Tooltip({ label, children }) {
  return (
    <span className="relative inline-block group">
      {children}
      <span role="tooltip" className="pointer-events-none select-none opacity-0 group-hover:opacity-100 transition text-[10px] px-2 py-1 rounded-md bg-slate-900/90 border border-slate-700/60 text-slate-300 absolute left-1/2 -translate-x-1/2 top-full mt-2 whitespace-nowrap z-50 shadow-lg shadow-black/50">{label}</span>
    </span>
  );
}

// Animowane tło siatki
function AnimatedGridBackground() {
  return (
    <div aria-hidden="true" className="pointer-events-none absolute inset-0 overflow-hidden">
      <div className="absolute inset-0 opacity-[0.15] [mask-image:radial-gradient(circle_at_center,white,transparent)]">
        <div className="absolute -inset-[200%] animate-[slowspin_40s_linear_infinite]" style={{ backgroundImage: 'linear-gradient(rgba(255,255,255,0.06) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.06) 1px,transparent 1px)', backgroundSize:'40px 40px' }} />
      </div>
      <style jsx>{`@keyframes slowspin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }`}</style>
    </div>
  );
}

// Profile diagnostics heurystyka
function computeProfileDiagnostics(result) {
  const f = result.factors || {};
  const tasks = [];
  if ((f.skills||0) < 0.55) tasks.push({ id:'skill_calibration', label:'Uzupełnij poziomy umiejętności', impact:'skills', risk:0.65, tip:'Lepsze dane poprawią trafność dopasowań.' });
  if ((f.personality||0) < 0.4) tasks.push({ id:'personality_quiz', label:'Wypełnij test stylu pracy', impact:'personalization', risk:0.5, tip:'Styl pracy personalizuje ranking.' });
  if ((f.values||0) < 0.35) tasks.push({ id:'values_check', label:'Określ wartości zawodowe', impact:'values', risk:0.45, tip:'Wartości zwiększają subiektywne dopasowanie.' });
  if (tasks.length===0) tasks.push({ id:'explore_more', label:'Eksploruj alternatywy (Swipe)', impact:'exploration', risk:0.3, tip:'Więcej zapisanych ról = bogatsza analiza.' });
  const benefits = [
    { icon:<CheckCircle2 className="w-5 h-5" />, label: f.skills>0.6? 'Silny profil umiejętności':'Profil do kalibracji', key:'skills' },
    { icon:<Gauge className="w-5 h-5" />, label: f.personality>0.5? 'Styl pracy OK':'Uzupełnij styl pracy', key:'style' },
    { icon:<BarChart3 className="w-5 h-5" />, label: f.market>0.45? 'Korzystny rynek':'Rynek neutralny', key:'market' },
    { icon:<Rocket className="w-5 h-5" />, label: f.salary>0.55? 'Potencjał wzrostu':'Sprawdź wyższe widełki', key:'growth' }
  ];
  return { tasks, benefits };
}

// ----------------------------- Koniec pliku ----------------------------- //
// Instrukcja podłączenia:
// 1. Import: import RecommendationSystem from '@/components/Recommendation/RecommendationSystem';
// 2. Użycie w stronie: <RecommendationSystem profile={userProfile} onSelectCareer={(id)=>router.push('/sciezka?role='+id)} />
// 3. Dane profilowe legacy (strengths/preferences/skills) mapowane automatycznie; można rozszerzyć o wartości i lokalizację.
// 4. Tryby: Hero / Swipe / Dashboard / Story / Legacy – przełącznik w nagłówku + hotkeys.
// 5. Persystencja decyzji i trybu w localStorage.
// 6. Gotowe do dalszego rozbijania na mniejsze pliki (HeroSection, SwipeDeck, itp.).
